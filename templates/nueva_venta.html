{% extends "base.html" %}
{% block content %}

<h2>Registrar nueva venta</h2>
<p class="text-muted mb-3">
  Registra una venta para un cliente y añade varias plataformas/servicios en la misma operación.
</p>

<form method="post">
  {# ---- TIPO DE CLIENTE ---- #}
  <div class="mb-3">
    <label class="form-label">Cliente</label>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="client_type" id="clienteExistente"
             value="existente" {% if client_type == 'existente' %}checked{% endif %}>
      <label class="form-check-label" for="clienteExistente">Cliente existente</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="client_type" id="clienteNuevo"
             value="nuevo" {% if client_type == 'nuevo' %}checked{% endif %}>
      <label class="form-check-label" for="clienteNuevo">Cliente nuevo</label>
    </div>
  </div>

  {# ---- CLIENTE EXISTENTE ---- #}
  <div id="bloqueClienteExistente" class="mb-3">
    <label class="form-label">Seleccionar cliente</label>
    <select name="client_id" class="form-select">
      <option value="">-- Selecciona un cliente --</option>
      {% for c in clients %}
        <option value="{{ c.id }}">{{ c.name }} {% if c.phone %} ({{ c.phone }}){% endif %}</option>
      {% endfor %}
    </select>
  </div>

  {# ---- CLIENTE NUEVO ---- #}
  <div id="bloqueClienteNuevo" class="mb-3" style="display:none;">
    <div class="row g-2">
      <div class="col-12 col-md-6">
        <label class="form-label">Nombre completo</label>
        <input type="text" name="new_name" class="form-control" placeholder="Nombre del cliente">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Código país</label>
        <select name="new_country_code" class="form-select">
          <option value="">Sin código</option>
          {% for code, label in country_codes %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Teléfono</label>
        <input type="text" name="new_phone" class="form-control" placeholder="Número de WhatsApp">
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">Correo (opcional)</label>
        <input type="email" name="new_email" class="form-control" placeholder="correo@ejemplo.com">
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">Notas (opcional)</label>
        <input type="text" name="new_notes" class="form-control" placeholder="Notas sobre el cliente">
      </div>
    </div>
  </div>

  <hr class="my-3">

  {# ---- DATOS GENERALES DE LA VENTA ---- #}
  <h5 class="mb-2">Datos generales de la venta</h5>
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-4">
      <label class="form-label">Vendedor</label>
      <select name="seller_id" class="form-select" required>
        <option value="">-- Selecciona un vendedor --</option>
        {% for v in sellers %}
          <option value="{{ v.id }}">{{ v.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-4">
      <label class="form-label">Fecha inicio</label>
      <input type="date" name="start_date" class="form-control" required
             value="{{ today.strftime('%Y-%m-%d') if today else '' }}">
    </div>
    <div class="col-6 col-md-4">
      <label class="form-label">Días de suscripción</label>
      <input type="number" name="days" class="form-control" value="30" min="1">
    </div>
  </div>

  <div class="row g-2 mb-4">
    <div class="col-6 col-md-4">
      <label class="form-label">Plataforma de contacto</label>
      <select name="platform" class="form-select">
        {% for value, label in platforms %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-4">
      <label class="form-label">Estado de pago</label>
      <select name="payment_status" class="form-select">
        {% for value, label in pay_statuses %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <hr class="my-3">

  {# ---- LÍNEAS DE SERVICIO / PLATAFORMAS ---- #}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">Plataformas / servicios incluidos</h5>
    <button id="btnAddLinea" class="btn btn-sm btn-outline-primary">
      + Añadir otra plataforma
    </button>
  </div>
  <small class="text-muted d-block mb-2">
    Todas las plataformas que agregues aquí usarán la misma fecha de inicio y la misma duración.
  </small>

  <div id="contenedorLineas">
    <div class="row g-2 align-items-end mb-2 linea-servicio">
      <div class="col-12 col-md-4">
        <label class="form-label">Cuenta / servicio</label>
        <select name="account_id[]" class="form-select">
          <option value="">-- Selecciona una cuenta --</option>
          {% for a in accounts %}
            <option value="{{ a.id }}">
              {{ a.service }} – {{ a.user }}
              ({{ a.used_slots }}/{{ a.total_slots }} usados)
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Perfil / slot</label>
        <input type="text" name="slot[]" class="form-control" placeholder="Perfil 1, Usuario X, etc.">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Precio</label>
        <input type="number" step="0.01" name="price[]" class="form-control" placeholder="0.00">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Moneda</label>
        <select name="currency[]" class="form-select">
          {% for code, label in currencies %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <button type="submit" class="btn btn-success">
      Guardar venta
    </button>
    <a href="{{ url_for('ventas') }}" class="btn btn-secondary">
      Cancelar
    </a>
  </div>
</form>

<script>
  // Toggle cliente existente / nuevo
  const radioExistente = document.getElementById('clienteExistente');
  const radioNuevo = document.getElementById('clienteNuevo');
  const bloqueExistente = document.getElementById('bloqueClienteExistente');
  const bloqueNuevo = document.getElementById('bloqueClienteNuevo');

  function actualizarBloquesCliente() {
    if (radioNuevo.checked) {
      bloqueNuevo.style.display = 'block';
      bloqueExistente.style.display = 'none';
    } else {
      bloqueNuevo.style.display = 'none';
      bloqueExistente.style.display = 'block';
    }
  }

  radioExistente.addEventListener('change', actualizarBloquesCliente);
  radioNuevo.addEventListener('change', actualizarBloquesCliente);
  actualizarBloquesCliente();

  // Añadir otra plataforma / servicio
  const btnAddLinea = document.getElementById('btnAddLinea');
  const contenedorLineas = document.getElementById('contenedorLineas');

  btnAddLinea.addEventListener('click', function (e) {
    e.preventDefault();
    const primera = contenedorLineas.querySelector('.linea-servicio');
    if (!primera) return;

    const nueva = primera.cloneNode(true);

    // Limpiar valores en la nueva fila
    nueva.querySelectorAll('input').forEach(input => {
      input.value = '';
    });
    nueva.querySelectorAll('select').forEach(select => {
      select.selectedIndex = 0;
    });

    contenedorLineas.appendChild(nueva);
  });
</script>

{% endblock %}
